<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Login - Share My Ride</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <main class="container form-container animate-fade-in-up">
    <h2><i class="fas fa-sign-in-alt"></i> User Login</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
      {% for category, message in messages %}
      <li class="{{ category }}">
        <i class="fas fa-{% if category == 'error' %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
        {{ message }}
      </li>
      {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <!-- The form now uses the FlaskForm object -->
    <form method="post" action="{{ url_for('auth.login') }}" novalidate>
      {{ form.hidden_tag() }} <!-- THIS LINE IS CRUCIAL FOR CSRF PROTECTION -->

      <div class="form-group">
        {{ form.username.label(class="form-label") }}
        {{ form.username(class="form-control", placeholder="Enter your username", autocomplete="username") }}
      </div>

      <div class="form-group">
        {{ form.password.label(class="form-label") }}
        <div class="input-with-icon">
          {{ form.password(class="form-control", placeholder="Enter your password", autocomplete="current-password") }}
          <i class="fas fa-eye" id="password-toggle" style="cursor: pointer;"></i>
        </div>
      </div>

      <div class="form-group">
        {{ form.submit(class="btn btn-primary", id="login-btn") }}
        <div class="spinner"></div>
      </div>
    </form>

    <a href="{{ url_for('main.home') }}" class="btn btn-ghost"
      style="width: 100%; margin-top: var(--space-4); justify-content: center;">
      <i class="fas fa-arrow-left"></i> Back to Home
    </a>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const passwordToggle = document.getElementById('password-toggle');
      const passwordInput = document.querySelector('input[type="password"]');
      const form = document.querySelector('form');
      const loginBtn = document.getElementById('login-btn');
      const btnContainer = loginBtn.parentElement;

      // Password visibility toggle
      if (passwordToggle && passwordInput) {
        passwordToggle.addEventListener('click', function () {
          const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          passwordInput.setAttribute('type', type);
          this.classList.toggle('fa-eye');
          this.classList.toggle('fa-eye-slash');
        });
      }

      // Form submission with loading state
      if (form) {
        form.addEventListener('submit', function (e) {
          // Show loading state
          btnContainer.classList.add('loading');
          loginBtn.disabled = true;
        });
      }
    });
  </script>
</body>

</html>