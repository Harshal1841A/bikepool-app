<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Register - Share My Ride</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <main class="container form-container animate-fade-in-up">
    <h2><i class="fas fa-user-plus"></i> Create Account</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
      {% for category, message in messages %}
      <li class="{{ category }}">
        <i class="fas fa-{% if category == 'error' %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
        {{ message }}
      </li>
      {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <form method="post" action="{{ url_for('auth.register') }}" novalidate>
      {{ form.hidden_tag() }}

      <div class="form-group">
        {{ form.username.label(class="form-label") }}
        {{ form.username(class="form-control", placeholder="Choose a unique username", id="username") }}
        <div class="invalid-feedback">
          {% if form.username.errors %}
          {% for error in form.username.errors %}
          <span>{{ error }}</span>
          {% endfor %}
          {% endif %}
        </div>
        <div id="username-check"
          style="color: var(--color-success); font-size: var(--font-size-sm); margin-top: var(--space-1); display: none;">
          <i class="fas fa-check-circle"></i> Username is available!
        </div>
      </div>

      <div class="form-group">
        {{ form.email.label(class="form-label") }}
        {{ form.email(class="form-control", placeholder="Enter your email address", id="email") }}
        <div class="invalid-feedback">
          {% if form.email.errors %}
          {% for error in form.email.errors %}
          <span>{{ error }}</span>
          {% endfor %}
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        {{ form.password.label(class="form-label") }}
        <div class="input-with-icon">
          {{ form.password(class="form-control", placeholder="Enter a strong password", id="password") }}
          <i class="fas fa-eye" id="password-toggle" style="cursor: pointer;"></i>
        </div>
        <div class="password-strength">
          <div class="password-strength-meter" id="strength-meter"></div>
        </div>
        <div class="password-strength-text" id="strength-text"></div>
        <div class="invalid-feedback">
          {% if form.password.errors %}
          {% for error in form.password.errors %}
          <span>{{ error }}</span>
          {% endfor %}
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        {{ form.gender.label(class="form-label") }}
        {{ form.gender(class="form-control") }}
        <div class="invalid-feedback">
          {% if form.gender.errors %}
          {% for error in form.gender.errors %}
          <span>{{ error }}</span>
          {% endfor %}
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        {{ form.gender_preference.label(class="form-label") }}
        {{ form.gender_preference(class="form-control") }}
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          {{ form.is_rider(class="form-check-input") }}
          {{ form.is_rider.label(class="form-check-label") }}
        </div>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          {{ form.terms(class="form-check-input") }}
          {{ form.terms.label(class="form-check-label") }}
        </div>
        <div class="invalid-feedback">
          {% if form.terms.errors %}
          {% for error in form.terms.errors %}
          <span>{{ error }}</span>
          {% endfor %}
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        {{ form.submit(class="btn btn-primary", id="register-btn") }}
        <div class="spinner"></div>
      </div>
    </form>

    <a href="{{ url_for('main.home') }}" class="btn btn-ghost"
      style="width: 100%; margin-top: var(--space-4); justify-content: center;">
      <i class="fas fa-arrow-left"></i> Back to Home
    </a>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.querySelector('form');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const passwordToggle = document.getElementById('password-toggle');
      const strengthMeter = document.getElementById('strength-meter');
      const strengthText = document.getElementById('strength-text');
      const usernameCheck = document.getElementById('username-check');
      const registerBtn = document.getElementById('register-btn');
      const btnContainer = registerBtn.parentElement;

      // Password visibility toggle
      passwordToggle.addEventListener('click', function () {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
      });

      // Password strength checker
      passwordInput.addEventListener('input', function () {
        const password = this.value;
        let strength = 0;
        let feedback = '';

        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]+/)) strength += 15;
        if (password.match(/[A-Z]+/)) strength += 15;
        if (password.match(/[0-9]+/)) strength += 15;
        if (password.match(/[$@#&!]+/)) strength += 30;

        strengthMeter.style.width = strength + '%';

        if (strength < 30) {
          strengthMeter.style.backgroundColor = '#e53e3e';
          feedback = 'Weak password';
        } else if (strength < 60) {
          strengthMeter.style.backgroundColor = '#dd6b20';
          feedback = 'Fair password';
        } else if (strength < 80) {
          strengthMeter.style.backgroundColor = '#d69e2e';
          feedback = 'Good password';
        } else {
          strengthMeter.style.backgroundColor = '#38a169';
          feedback = 'Strong password';
        }

        strengthText.textContent = feedback;
      });

      // Username availability check
      let usernameCheckTimeout;
      usernameInput.addEventListener('input', function () {
        clearTimeout(usernameCheckTimeout);
        const username = this.value;

        if (username.length < 3) {
          usernameCheck.style.display = 'none';
          return;
        }

        usernameCheckTimeout = setTimeout(function () {
          fetch(`/api/check_username?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
              if (data.available) {
                usernameCheck.style.display = 'block';
                usernameInput.style.borderColor = 'var(--color-success)';
              } else {
                usernameCheck.style.display = 'none';
                usernameInput.style.borderColor = 'var(--color-error)';
              }
            })
            .catch(error => {
              console.error('Error checking username:', error);
              usernameCheck.style.display = 'none';
            });
        }, 500);
      });

      // Form submission with loading state
      form.addEventListener('submit', function (e) {
        // Basic client-side validation
        if (!form.terms.checked) {
          e.preventDefault();
          alert('You must agree to the Terms and Conditions.');
          return;
        }

        // Show loading state
        btnContainer.classList.add('loading');
        registerBtn.disabled = true;
      });
    });
  </script>
</body>

</html>