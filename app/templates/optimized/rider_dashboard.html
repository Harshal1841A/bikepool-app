<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Rider Dashboard - Share My Ride</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <header>
    <img src="{{ url_for('static', filename='logo.svg') }}" alt="Share My Ride logo" />
    <nav>
      <a href="{{ url_for('main.dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="{{ url_for('main.notifications') }}">
        <i class="fas fa-bell"></i> Notifications
        {% if unread_notifications_count > 0 %}
        <span class="notification-badge">{{ unread_notifications_count }}</span>
        {% endif %}
      </a>
      <a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
  </header>

  <div class="container animate-fade-in-up">
    <h2>
      <span><i class="fas fa-user-circle"></i> Welcome, {{ session.username }} (Bike Rider) üèçÔ∏è</span>
      <a href="{{ url_for('rides.post_bike_ride') }}" class="btn btn-primary">
        <i class="fas fa-plus-circle"></i> Post a Bike Ride
      </a>
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
      {% for category, message in messages %}
      <li class="{{ category }}">
        <i
          class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
        {{ message }}
      </li>
      {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number">{{ rides_data|selectattr('is_future_ride')|list|length }}</div>
        <div class="stat-label">Upcoming Rides</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ rides_data|selectattr('is_completed')|list|length }}</div>
        <div class="stat-label">Completed Rides</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ '%.1f'|format(avg_rating) if avg_rating is not none else 'N/A' }}</div>
        <div class="stat-label">Average Rating</div>
      </div>
    </div>

    <div class="card" style="margin-bottom: var(--space-6); padding: var(--space-4);">
      <div class="filter-container"
        style="background: none; padding: 0; box-shadow: none; display: flex; gap: var(--space-3); flex-wrap: wrap;">
        <input type="text" id="search-input" class="filter-input" placeholder="Search by destination...">
        <select id="status-filter" class="filter-select">
          <option value="">All Rides</option>
          <option value="upcoming">Upcoming</option>
          <option value="completed">Completed</option>
        </select>
        <button id="filter-btn" class="btn btn-primary">Apply Filters</button>
        <button id="reset-btn" class="btn btn-ghost">Reset</button>
      </div>
    </div>

    <h3><i class="fas fa-route"></i> Your Posted Bike Rides</h3>
    <ul id="rides-list">
      {% for item in rides_data %}
      <li class="card ride-item {% if item.is_completed %}completed{% endif %}"
        data-destination="{{ item.ride.destination|lower }}"
        data-status="{% if item.is_completed %}completed{% else %}upcoming{% endif %}">
        <div class="ride-details">
          <div class="ride-route">
            <i class="fas fa-map-marker-alt"></i>
            <strong>{{ item.ride.source }}</strong> to <strong>{{ item.ride.destination }}</strong>
          </div>
          <div class="ride-meta">
            <div class="ride-meta-item">
              <i class="fas fa-calendar"></i> {{ item.ride.ride_date }}
            </div>
            <div class="ride-meta-item">
              <i class="fas fa-clock"></i> {{ item.ride.ride_time.strftime("%H:%M") }} - {{
              item.ride.ride_end_time.strftime("%H:%M") if item.ride.ride_end_time else 'N/A' }}
            </div>
            <div class="ride-meta-item">
              <i class="fas fa-chair"></i> {{ item.ride.seats_available }} seat{{ 's' if item.ride.seats_available != 1
              else '' }} left
            </div>
          </div>
        </div>
        <div class="passenger-list">
          <i class="fas fa-users"></i>
          <span>Passengers:</span>
          {% if item.passengers %}
          <div class="passenger-avatars">
            {% for passenger in item.passengers %}
            <div class="passenger-avatar" title="{{ passenger }}">{{ passenger[0]|upper }}</div>
            {% endfor %}
          </div>
          <span style="margin-left: var(--space-2);">{{ item.passengers | join(', ') }}</span>
          {% else %}
          <span style="margin-left: var(--space-2);">None yet</span>
          {% endif %}
        </div>
        {% if item.is_completed %}
        <div class="rating-info" style="background: var(--color-warning); color: white;">
          <i class="fas fa-check-circle"></i> Ride Completed
        </div>
        {% else %}
        <div class="rating-info {% if item.ride.ratings %}rating-with-reviews{% else %}rating-no-reviews{% endif %}">
          {% if item.ride.ratings %}
          <i class="fas fa-star"></i> Avg: {{ '%.1f'|format(item.ride.ratings | sum(attribute='rating_value') /
          item.ride.ratings | length) }}
          {% else %}
          <i class="fas fa-star-half-alt"></i> No ratings yet
          {% endif %}
        </div>
        {% endif %}
        <div class="ride-actions">
          <a class="btn btn-secondary" href="{{ url_for('rides.ride_chat', ride_id=item.ride.id) }}">
            <i class="fas fa-comments"></i> Chat
          </a>
          {% if not item.is_completed %}
          <!-- THIS IS THE CRITICAL FORM -->
          <form method="post" action="{{ url_for('rides.delete_ride', ride_id=item.ride.id) }}" class="delete-form"
            style="display: inline;">
            {{ delete_form.hidden_tag() }}
            <button type="submit" class="btn btn-danger delete-btn">
              <i class="fas fa-trash"></i>
              <span class="btn-text">Delete Ride</span>
              <div class="spinner"></div>
            </button>
          </form>
          {% endif %}
        </div>
      </li>
      {% else %}
      <li class="card" style="text-align: center; color: var(--color-neutral-500);">
        <i class="fas fa-route" style="font-size: 3rem; margin-bottom: var(--space-4); display: block;"></i>
        No rides posted yet.
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <i class="fas fa-exclamation-triangle" style="color: var(--color-warning);"></i>
        <h3 class="modal-title" id="modal-title">Confirm Action</h3>
      </div>
      <div class="modal-body">
        <p id="modal-message">Are you sure you want to delete this ride? This action cannot be undone and will cancel
          all bookings for this ride.</p>
      </div>
      <div class="modal-footer">
        <button id="modal-cancel" class="btn btn-ghost">Cancel</button>
        <button id="modal-confirm" class="btn btn-danger">Delete Ride</button>
      </div>
    </div>
  </div>

  <!-- NEW DEBUG BLOCK - PASTE THIS INSTEAD -->
  {% if session.is_rider %}
  {% if delete_form %}
  <p
    style="position: fixed; top: 10px; left: 10px; background: lime; color: black; padding: 5px; z-index: 1000; font-weight: bold;">
    SUCCESS: Logged in as Rider and delete_form is present.
  </p>
  {% else %}
  <p
    style="position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 5px; z-index: 1000; font-weight: bold;">
    ERROR: Logged in as Rider but delete_form is MISSING!
  </p>
  {% endif %}
  {% else %}
  <p
    style="position: fixed; top: 10px; left: 10px; background: orange; color: black; padding: 5px; z-index: 1000; font-weight: bold;">
    INFO: Logged in as PASSENGER. Delete form is not needed.
  </p>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ... (keep your existing javascript for filtering and modals) ...
    });
  </script>
</body>

</html>